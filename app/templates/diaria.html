<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Agenda Diária - Corte em Dia</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='svg/logo.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/diaria.css') }}" />
</head>
<body>
    {% include 'partials/sidebar.html' %}

    <main class="content" role="main">
        <h1>Agenda Diária</h1>

        <form method="GET" action="{{ url_for('agenda.agenda_diaria') }}">
            <section class="filtros-container" aria-label="Filtros de busca">
                <div class="form-group">
                    <label for="datePicker">Data:</label>
                    <input type="date" id="datePicker" name="data" value="{{ data_selecionada }}" />
                </div>
                <div class="form-group">
                    <label for="selectProfissional">Profissional:</label>
                    <select id="selectProfissional" name="profissional">
                        {% for prof_id, prof_data in profissionais.items() %}
                            <option value="{{ prof_id }}" {% if prof_id == profissional_selecionado %}selected{% endif %}>
                                {{ prof_data.nome }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="btn-filtrar">Filtrar</button>
                <a href="{{ url_for('agenda.abrir_agenda') }}" class="btn-abrir-agenda" role="button">Abrir Agenda</a>
            </section>
        </form>

        <section aria-label="Tabela de agendamentos">
            <table id="agendaTable" role="grid">
                <thead>
                    <tr>
                        <th>Hora</th>
                        <th>Cliente</th>
                        <th>Procedimento</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="agendaTbody">
                    {% for slot in slots %}
                        <tr class="status-{{ slot.status }}" data-agendamento-id="{{ slot.agendamento_id }}">
                            <td><strong>{{ slot.hora }}</strong></td>
                            <td>
                                {# Mostra '---' se não houver cliente associado #}
                                {{ slot.cliente_nome or '---' }}
                            </td>
                            <td>
                                {{ slot.procedimento_nome or '---' }}
                            </td>
                            <td>
                                {# Badge de Status com cor #}
                                {% if slot.status == 'vago' %}
                                    <span class="status status-vago">Vago</span>
                                
                                {% elif slot.status == 'agendado' or slot.status == 'ocupado' %}
                                    <span class="status status-ocupado">Agendado</span>

                                {% elif slot.status == 'faltou' %}
                                    <span class="status status-faltou">Faltou</span>

                                {% elif slot.status == 'bloqueado' %}
                                    <span class="status status-bloqueado">Bloqueado</span>
                                
                                {% elif slot.status == 'recebido' %}
                                    <span class="status status-recebido">Recebido</span>
                                {% endif %}
                            </td>
                            <td>
                                {# Lógica para mostrar ações apenas quando aplicável #}
                                {% if slot.status == 'vago' %}
                                    <button class="btn-agendar" 
                                            data-profissional-id="{{ slot.profissional_id }}"
                                            data-profissional-nome="{{ slot.profissional_nome }}"
                                            data-dia="{{ slot.data }}" 
                                            data-hora="{{ slot.hora }}">
                                        Agendar
                                    </button>
                                {% elif slot.status == 'ocupado' or slot.status == 'agendado' %}
                                    <div class="acoes-multiplas">
                                        <button class="btn-receber" 
                                                data-agendamento-id="{{ slot.agendamento_id }}"
                                                data-procedimento-id="{{ slot.procedimento_id }}">
                                            Receber
                                        </button>
                                        <button class="btn-desmarcar" data-agendamento-id="{{ slot.agendamento_id }}">Desmarcar</button>
                                    </div>
                                {% endif %}
                                {# Para 'faltou' e 'bloqueado', nada é renderizado aqui #}
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="5">Nenhuma disponibilidade encontrada para esta data/profissional.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
    </main>

    <div id="modalAgendamento" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitulo">Novo Agendamento</h3>
            <form id="formAgendamento" method="POST" action="{{ url_for('agenda.salvar_agendamento') }}">
                <input type="hidden" id="modalProfissionalId" name="profissionalId" />
                <input type="hidden" id="modalDia" name="dia" />
                <input type="hidden" id="modalHora" name="hora" />
                <div class="form-group">
                    <label for="selectCliente">Cliente:</label>
                    <select id="selectCliente" name="clienteId" required></select>
                </div>
                <div class="form-group">
                    <label for="selectProcedimento">Procedimento:</label>
                    <select id="selectProcedimento" name="procedimentoId" required></select>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn-salvar">Salvar Agendamento</button>
                    <button type="button" id="btnCancelar" class="btn-cancelar">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-pagamento" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2>Forma de Pagamento</h2>
            <p>Selecione como o cliente irá pagar.</p>
            <div class="opcoes-pagamento">
                <button class="btn-pagamento" data-metodo="Dinheiro">Dinheiro</button>
                <button class="btn-pagamento" data-metodo="Pix">Pix</button>
                <button class="btn-pagamento" data-metodo="Débito">Débito</button>
                <button class="btn-pagamento" data-metodo="Crédito">Crédito</button>
            </div>
            <input type="hidden" id="pagamento-agendamento-id">
            <input type="hidden" id="pagamento-procedimento-id">
        </div>
    </div>

    <div id="modal-detalhes" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2>Confirmar Recebimento</h2>

            <div id="view-valor-comum">
                <div class="detalhes-valor">
                    <span>Pagamento em</span>
                    <strong id="metodo-selecionado"></strong>
                    <div class="valor-display">
                        R$ <span id="valor-procedimento">--,--</span>
                    </div>
                </div>
                <button class="btn-confirmar">Confirmar Recebimento</button>
            </div>

            <div id="view-pix" style="display: none;">
                <p>Peça para o cliente escanear o QR Code abaixo:</p>
                <div class="pix-container">
                    <img id="qr-code-img" src="" alt="QR Code Pix" /><br>
                    <label for="pix-copia-cola-input">Ou use o Pix Copia e Cola:</label>
                    <div class="copia-cola-wrapper">
                        <input type="text" id="pix-copia-cola-input" readonly />
                        <button id="btn-copiar-pix">Copiar</button>
                    </div>
                </div>
                <button class="btn-confirmar">Pagamento Recebido</button>
            </div>
        </div>
    </div>

    <script>
        const clientes = {{ clientes | tojson }};
        const procedimentos = {{ procedimentos | tojson }};
    </script>
    
    <script type="module" src="{{ url_for('static', filename='js/diaria.js') }}"></script>

</body>
</html>